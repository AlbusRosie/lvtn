const BaseIntentHandler = require('./BaseIntentHandler');const MenuHandler = require('../MenuHandler');const ToolHandlers = require('../ToolHandlers');const Utils = require('../Utils');class SearchIntentHandler extends BaseIntentHandler {    constructor() {        super();        this.intentSet = new Set(['search_food', 'search_product', 'search_branches_by_location']);    }    canHandle(intent, _context, metadata = {}) {        return this.intentSet.has(intent) || metadata?.isSearchQuery;    }    async handle({ intent, message, context, entities, aiResponse }) {        if (aiResponse && aiResponse.tool_results && aiResponse.tool_results.length > 0) {            const normalized = Utils.normalizeEntityFields(entities || {});            return this.buildResponse({                intent: aiResponse.intent || intent || 'search_product',                response: aiResponse.response,                entities: normalized,                suggestions: aiResponse.suggestions || [],            });        }        const keyword = MenuHandler.extractFoodSearchKeyword(message);        if (!keyword || keyword === 'm√≥n ƒÉn') {            const result = await MenuHandler.handleMenuQuery(message, context);            if (result) {                return result;            }        } else {            try {                const normalizedEntities = Utils.normalizeEntityFields(entities || {});                const branchId = normalizedEntities.branch_id || context.branch?.id || context.conversationContext?.lastBranchId;                const searchParams = {                    keyword: keyword,                    branch_id: branchId || null,                     limit: 10                };                const searchResult = await ToolHandlers.searchProducts(searchParams);                if (searchResult && searchResult.products && searchResult.products.length > 0) {                    const products = searchResult.products;                    let responseText = `üîç T√¨m th·∫•y ${products.length} m√≥n:\n\n`;                    products.forEach((product, idx) => {                        responseText += `${idx + 1}. ${product.name}`;                        if (product.price) {                            responseText += ` - ${product.price.toLocaleString()}ƒë`;                        }                        if (product.description) {                            responseText += `\n   ${product.description}`;                        }                        if (product.category_name) {                            responseText += `\n   üìÇ ${product.category_name}`;                        }                        responseText += '\n\n';                    });                    responseText += 'B·∫°n mu·ªën xem chi ti·∫øt m√≥n n√†o ho·∫∑c ƒë·∫∑t m√≥n?';                    return this.buildResponse({                        intent: intent || 'search_food',                        response: responseText,                        entities: normalizedEntities,                        suggestions: []                    });                } else {                    return this.buildResponse({                        intent: intent || 'search_food',                        response: `üòî T√¥i kh√¥ng t√¨m th·∫•y m√≥n n√†o v·ªõi t·ª´ kh√≥a "${keyword}". B·∫°n c√≥ th·ªÉ th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c cho t√¥i bi·∫øt chi nh√°nh c·ª• th·ªÉ kh√¥ng?`,                        entities: normalizedEntities,                    });                }            } catch (error) {                const result = await MenuHandler.handleMenuQuery(message, context);                if (result) {                    return result;                }            }        }        const normalized = Utils.normalizeEntityFields(entities || {});        return this.buildResponse({            intent: intent || 'search_food',            response: 'T√¥i ch∆∞a t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p. B·∫°n c√≥ th·ªÉ m√¥ t·∫£ chi ti·∫øt h∆°n v·ªÅ m√≥n ƒÉn ho·∫∑c chi nh√°nh b·∫°n c·∫ßn kh√¥ng?',            entities: normalized,        });    }}module.exports = SearchIntentHandler;