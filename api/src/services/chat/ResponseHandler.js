const Utils = require('./Utils');const knex = require('../../database/knex');const BranchHandler = require('./BranchHandler');class ResponseHandler {    async getSuggestions(intent, branchId) {        const suggestions = [];        switch (intent) {            case 'greeting':            case 'hello':                suggestions.push(                    { text: 'ğŸª‘ Äáº·t bÃ n', action: 'book_table', data: { branch_id: branchId } },                    { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: { branch_id: branchId } },                    { text: 'ğŸ“ Xem chi nhÃ¡nh', action: 'view_branches', data: {} }                );                break;            case 'book_table_partial':            case 'ask_info':            case 'ask_time_period':                break;            case 'confirm_booking':            case 'book_table_confirmed':                suggestions.push(                    { text: 'âœ… Táº¡o Ä‘áº·t bÃ n ngay', action: 'confirm_booking', data: { branch_id: branchId } },                    { text: 'ğŸ“ ThÃªm ghi chÃº', action: 'add_note', data: {} },                    { text: 'ğŸ”„ Thay Ä‘á»•i thá»i gian', action: 'modify_booking', data: {} }                );                break;            case 'cancel_booking':            case 'book_table_cancelled':                suggestions.push(                    { text: 'ğŸª‘ Äáº·t bÃ n má»›i', action: 'book_table', data: { branch_id: branchId } },                    { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: { branch_id: branchId } }                );                break;            case 'search_food':                suggestions.push(                    { text: 'ğŸ” TÃ¬m kiáº¿m khÃ¡c', action: 'search_food', data: { branch_id: branchId } },                    { text: 'ğŸ½ï¸ Xem toÃ n bá»™ menu', action: 'view_menu', data: { branch_id: branchId } },                    { text: 'ğŸ›’ Äáº·t mÃ³n ngay', action: 'order_food', data: { branch_id: branchId } }                );                break;            case 'view_menu_specific_branch':                suggestions.push(                    { text: 'ğŸ›’ Äáº·t mÃ³n ngay', action: 'order_food', data: { branch_id: branchId } },                    { text: 'ğŸª‘ Äáº·t bÃ n', action: 'book_table', data: { branch_id: branchId } },                    { text: 'ğŸ“ Xem chi nhÃ¡nh khÃ¡c', action: 'view_branches', data: {} }                );                break;            case 'order_food_specific_branch':                suggestions.push(                    { text: 'ğŸ›’ Xem giá» hÃ ng', action: 'view_cart', data: { branch_id: branchId } },                    { text: 'ğŸ“‹ Xem menu Ä‘áº§y Ä‘á»§', action: 'view_menu', data: { branch_id: branchId } }                );                break;            case 'book_table_specific_branch':                break;            case 'find_nearest_branch':                suggestions.push(                    { text: 'ğŸª‘ Äáº·t bÃ n táº¡i chi nhÃ¡nh nÃ y', action: 'book_table', data: {} },                    { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: {} },                    { text: 'ğŸ“ Xem táº¥t cáº£ chi nhÃ¡nh', action: 'view_branches', data: {} }                );                break;            case 'find_first_branch':                suggestions.push(                    { text: 'ğŸª‘ Äáº·t bÃ n táº¡i chi nhÃ¡nh nÃ y', action: 'book_table', data: {} },                    { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: {} },                    { text: 'ğŸ“ Xem táº¥t cáº£ chi nhÃ¡nh', action: 'view_branches', data: {} }                );                break;            case 'view_menu':                if (!branchId) {                    try {                        const allBranches = await BranchHandler.getAllActiveBranches();                        if (allBranches.length > 0) {                            const branchSuggestions = await BranchHandler.createBranchSuggestions(allBranches, {                                intent: 'view_menu'                            });                            suggestions.push(...branchSuggestions);                        } else {                            suggestions.push(                                { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: {} }                            );                        }                    } catch (error) {                        suggestions.push(                            { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: {} }                        );                    }                } else {                    try {                        const categories = await knex('categories')                            .select('id', 'name')                            .where('status', 'active')                            .orderBy('name', 'asc')                            .limit(5);                         categories.forEach(cat => {                            const emoji = this.getCategoryEmoji(cat.name);                            suggestions.push({                                text: `${emoji} ${cat.name}`,                                action: 'view_category',                                data: { category: cat.name }                            });                        });                    } catch (error) {                        suggestions.push(                            { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: { branch_id: branchId } }                        );                    }                }                break;            case 'order_food':                suggestions.push(                    { text: 'ğŸ›’ Xem giá» hÃ ng', action: 'view_cart', data: { branch_id: branchId } },                    { text: 'ğŸ“‹ Xem menu', action: 'view_menu', data: { branch_id: branchId } }                );                break;            case 'book_table':                break;            case 'ask_branch':                suggestions.push(                    { text: 'ğŸ“ Chi nhÃ¡nh gáº§n nháº¥t', action: 'find_nearest_branch', data: {} },                    { text: 'ğŸ¢ Chi nhÃ¡nh Ä‘áº§u tiÃªn', action: 'find_first_branch', data: {} },                    { text: 'ğŸ—ºï¸ Xem táº¥t cáº£ chi nhÃ¡nh', action: 'view_branches', data: {} }                );                break;            case 'show_booking_info':                suggestions.push(                    { text: 'âœ… XÃ¡c nháº­n Ä‘áº·t bÃ n', action: 'confirm_booking', data: {} },                    { text: 'ğŸ”„ Thay Ä‘á»•i thÃ´ng tin', action: 'modify_booking', data: {} },                    { text: 'âŒ Há»§y Ä‘áº·t bÃ n', action: 'cancel_booking', data: {} }                );                break;            case 'reservation_created':                suggestions.push(                    { text: 'ğŸ½ï¸ Äáº·t mÃ³n ngay', action: 'order_food', data: { branch_id: branchId } },                    { text: 'ğŸ“‹ Xem menu Ä‘áº§y Ä‘á»§', action: 'view_menu', data: { branch_id: branchId } },                    { text: 'ğŸ“ Gá»i Ä‘iá»‡n xÃ¡c nháº­n', action: 'call_confirmation', data: {} }                );                break;            case 'reservation_failed':                suggestions.push(                    { text: 'ğŸ”„ Thá»­ láº¡i', action: 'book_table', data: { branch_id: branchId } },                    { text: 'ğŸ“ Gá»i Ä‘áº·t bÃ n', action: 'call_booking', data: {} },                    { text: 'ğŸ“ Chá»n chi nhÃ¡nh khÃ¡c', action: 'select_branch', data: {} }                );                break;            default:                suggestions.push(                    { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: { branch_id: branchId } },                    { text: 'ğŸª‘ Äáº·t bÃ n', action: 'book_table', data: { branch_id: branchId } },                    { text: 'ğŸ“ Chi nhÃ¡nh gáº§n tÃ´i', action: 'find_nearest_branch', data: {} }                );        }        return suggestions;    }    determineAction(intent, entities) {        switch (intent) {            case 'view_menu':                return {                    name: 'navigate_menu',                    data: entities,                };            case 'confirm_booking':            case 'book_table_confirmed':                return {                    name: 'confirm_booking',                    data: entities,                };            case 'cancel_booking':            case 'book_table_cancelled':                return {                    name: 'cancel_booking',                    data: {},                };            case 'view_orders':                return {                    name: 'navigate_orders',                    data: {},                };            case 'reservation_created':                return {                    name: 'show_reservation_details',                    data: entities,                };            case 'order_food':                return {                    name: 'navigate_menu',                    data: entities,                };            default:                return null;        }    }    getMessageType(intent) {        const typeMap = {            'view_menu': 'menu',            'order_food': 'order',            'book_table': 'reservation',            'confirm_booking': 'reservation',            'cancel_booking': 'reservation',            'book_table_confirmed': 'reservation',            'book_table_cancelled': 'reservation',            'reservation_created': 'reservation',            'reservation_failed': 'reservation',            'show_booking_info': 'reservation',            'view_orders': 'order',        };        return typeMap[intent] || 'text';    }    getDefaultSuggestions(branchId) {        return [            { text: 'ğŸ½ï¸ Xem menu', action: 'view_menu', data: { branch_id: branchId } },            { text: 'ğŸ” TÃ¬m kiáº¿m mÃ³n', action: 'search_food', data: { branch_id: branchId } },            { text: 'ğŸª‘ Äáº·t bÃ n', action: 'book_table', data: { branch_id: branchId } },            { text: 'ğŸ“ Chi nhÃ¡nh gáº§n tÃ´i', action: 'find_branch', data: {} },            { text: 'ğŸ“¦ ÄÆ¡n hÃ ng cá»§a tÃ´i', action: 'view_orders', data: {} },        ];    }    getCategoryEmoji(categoryName) {        const lower = categoryName.toLowerCase();        if (lower.includes('main') || lower.includes('chÃ­nh') || lower.includes('course')) return 'ğŸ½ï¸';        if (lower.includes('dessert') || lower.includes('trÃ¡ng miá»‡ng') || lower.includes('trang mieng')) return 'ğŸ°';        if (lower.includes('appetizer') || lower.includes('khai vá»‹') || lower.includes('khai vi')) return 'ğŸ¥—';        if (lower.includes('salad') || lower.includes('xÃ  lÃ¡ch') || lower.includes('xa lach')) return 'ğŸ¥—';        if (lower.includes('pizza')) return 'ğŸ•';        if (lower.includes('burger') || lower.includes('bÃ¡nh mÃ¬') || lower.includes('banh mi')) return 'ğŸ”';        if (lower.includes('pasta') || lower.includes('mÃ¬') || lower.includes('mi')) return 'ğŸ';        if (lower.includes('soup') || lower.includes('sÃºp') || lower.includes('sup') || lower.includes('canh')) return 'ğŸ²';        if (lower.includes('drink') || lower.includes('Ä‘á»“ uá»‘ng') || lower.includes('do uong')) return 'ğŸ¥¤';        return 'ğŸ½ï¸';     }    async fallbackResponse(userMessage, context) {        throw new Error('fallbackResponse should be called from ChatService with dependencies');    }}module.exports = new ResponseHandler();