const knex = require('../database/knex');const ApiError = require('../api-error');const { ROLE_ID_MAP } = require('../constants');async function enforceBranchAccess(req, res, next) {    try {        if (!req.user || !req.user.id) {            return next();        }        const userRole = ROLE_ID_MAP[req.user.role_id];        if (userRole === 'admin') {            return next();        }        if (userRole === 'manager' || userRole === 'kitchen_staff') {            const user = await knex('users')                .select('branch_id')                .where('id', req.user.id)                .first();            if (!user || !user.branch_id) {                const roleName = userRole === 'manager' ? 'Manager' : 'Kitchen Staff';                return next(new ApiError(403, `${roleName} must be assigned to a branch`));            }            req.managerBranchId = user.branch_id;            if (req.method === 'GET') {                req.query.branch_id = user.branch_id.toString();            }            if ((req.method === 'POST' || req.method === 'PUT') && req.body) {                if (req.body.branch_id && parseInt(req.body.branch_id) !== user.branch_id) {                    return next(new ApiError(403, 'Cannot access data from other branches'));                }                if (!req.body.branch_id) {                    req.body.branch_id = user.branch_id;                }            }        }        next();    } catch (error) {        next(error);    }}async function attachUserBranch(req, res, next) {    try {        if (!req.user || !req.user.id) {            return next();        }        const user = await knex('users')            .select('branch_id')            .where('id', req.user.id)            .first();        if (user && user.branch_id) {            req.userBranchId = user.branch_id;        }        next();    } catch (error) {        next(error);    }}function validateResourceBranch(resourceType) {    return async (req, res, next) => {        try {            if (!req.user || !req.user.id) {                return next();            }            const userRole = ROLE_ID_MAP[req.user.role_id];            if (userRole === 'admin') {                return next();            }            if (userRole === 'manager') {                const resourceId = req.params.id;                if (!resourceId) {                    return next();                }                const user = await knex('users')                    .select('branch_id')                    .where('id', req.user.id)                    .first();                if (!user || !user.branch_id) {                    return next(new ApiError(403, 'Manager must be assigned to a branch'));                }                let resource;                switch (resourceType) {                    case 'order':                        resource = await knex('orders')                            .select('branch_id')                            .where('id', resourceId)                            .first();                        break;                    case 'reservation':                        resource = await knex('reservations')                            .select('branch_id')                            .where('id', resourceId)                            .first();                        break;                    case 'table':                        resource = await knex('tables')                            .join('floors', 'tables.floor_id', 'floors.id')                            .select('floors.branch_id')                            .where('tables.id', resourceId)                            .first();                        break;                    case 'user':                        resource = await knex('users')                            .select('branch_id')                            .where('id', resourceId)                            .first();                        break;                    default:                        return next();                }                if (!resource) {                    return next(new ApiError(404, `${resourceType} not found`));                }                if (resource.branch_id !== user.branch_id) {                    return next(new ApiError(403, 'Cannot access resources from other branches'));                }            }            next();        } catch (error) {            next(error);        }    };}module.exports = {    enforceBranchAccess,    attachUserBranch,    validateResourceBranch};