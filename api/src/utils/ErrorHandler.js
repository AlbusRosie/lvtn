class AppError extends Error {    constructor(code, message, statusCode = 500, details = null) {        super(message);        this.code = code;        this.statusCode = statusCode;        this.details = details;        this.isOperational = true;         Error.captureStackTrace(this, this.constructor);    }}const ERROR_CODES = {    INVALID_INPUT: 'INVALID_INPUT',    MISSING_REQUIRED_FIELD: 'MISSING_REQUIRED_FIELD',    INVALID_DATE_FORMAT: 'INVALID_DATE_FORMAT',    INVALID_TIME_FORMAT: 'INVALID_TIME_FORMAT',    UNAUTHORIZED: 'UNAUTHORIZED',    TOKEN_EXPIRED: 'TOKEN_EXPIRED',    INVALID_TOKEN: 'INVALID_TOKEN',    FORBIDDEN: 'FORBIDDEN',    INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',    BRANCH_NOT_FOUND: 'BRANCH_NOT_FOUND',    USER_NOT_FOUND: 'USER_NOT_FOUND',    CONVERSATION_NOT_FOUND: 'CONVERSATION_NOT_FOUND',    PRODUCT_NOT_FOUND: 'PRODUCT_NOT_FOUND',    RESERVATION_NOT_FOUND: 'RESERVATION_NOT_FOUND',    BRANCH_CLOSED: 'BRANCH_CLOSED',    NO_TABLES_AVAILABLE: 'NO_TABLES_AVAILABLE',    INVALID_TIME_SLOT: 'INVALID_TIME_SLOT',    BOOKING_FULL: 'BOOKING_FULL',    CAPACITY_EXCEEDED: 'CAPACITY_EXCEEDED',    PAST_DATE_NOT_ALLOWED: 'PAST_DATE_NOT_ALLOWED',    RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',    TOO_MANY_REQUESTS: 'TOO_MANY_REQUESTS',    INTERNAL_ERROR: 'INTERNAL_ERROR',    DATABASE_ERROR: 'DATABASE_ERROR',    AI_SERVICE_ERROR: 'AI_SERVICE_ERROR',    EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',};const ERROR_MESSAGES = {    [ERROR_CODES.INVALID_INPUT]: 'Dữ liệu không hợp lệ',    [ERROR_CODES.MISSING_REQUIRED_FIELD]: 'Thiếu thông tin bắt buộc',    [ERROR_CODES.INVALID_DATE_FORMAT]: 'Định dạng ngày không hợp lệ',    [ERROR_CODES.INVALID_TIME_FORMAT]: 'Định dạng giờ không hợp lệ',    [ERROR_CODES.UNAUTHORIZED]: 'Bạn cần đăng nhập để sử dụng tính năng này',    [ERROR_CODES.TOKEN_EXPIRED]: 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại',    [ERROR_CODES.INVALID_TOKEN]: 'Token không hợp lệ',    [ERROR_CODES.FORBIDDEN]: 'Bạn không có quyền truy cập tính năng này',    [ERROR_CODES.INSUFFICIENT_PERMISSIONS]: 'Bạn không có quyền thực hiện hành động này',    [ERROR_CODES.BRANCH_NOT_FOUND]: 'Không tìm thấy chi nhánh',    [ERROR_CODES.USER_NOT_FOUND]: 'Không tìm thấy người dùng',    [ERROR_CODES.CONVERSATION_NOT_FOUND]: 'Không tìm thấy cuộc trò chuyện',    [ERROR_CODES.PRODUCT_NOT_FOUND]: 'Không tìm thấy món ăn',    [ERROR_CODES.RESERVATION_NOT_FOUND]: 'Không tìm thấy đặt bàn',    [ERROR_CODES.BRANCH_CLOSED]: 'Chi nhánh không hoạt động vào thời gian này',    [ERROR_CODES.NO_TABLES_AVAILABLE]: 'Không còn bàn trống vào thời gian này',    [ERROR_CODES.INVALID_TIME_SLOT]: 'Khung giờ không hợp lệ',    [ERROR_CODES.BOOKING_FULL]: 'Đặt bàn đã đầy',    [ERROR_CODES.CAPACITY_EXCEEDED]: 'Vượt quá sức chứa của bàn',    [ERROR_CODES.PAST_DATE_NOT_ALLOWED]: 'Không thể đặt bàn cho ngày trong quá khứ',    [ERROR_CODES.RATE_LIMIT_EXCEEDED]: 'Bạn đã gửi quá nhiều yêu cầu. Vui lòng thử lại sau',    [ERROR_CODES.TOO_MANY_REQUESTS]: 'Quá nhiều yêu cầu trong thời gian ngắn',    [ERROR_CODES.INTERNAL_ERROR]: 'Đã có lỗi xảy ra. Vui lòng thử lại sau',    [ERROR_CODES.DATABASE_ERROR]: 'Lỗi cơ sở dữ liệu',    [ERROR_CODES.AI_SERVICE_ERROR]: 'Lỗi dịch vụ AI',    [ERROR_CODES.EXTERNAL_SERVICE_ERROR]: 'Lỗi dịch vụ bên ngoài',};class ErrorHandler {    static createError(code, customMessage = null, statusCode = null, details = null) {        const message = customMessage || ERROR_MESSAGES[code] || 'Đã có lỗi xảy ra';        const status = statusCode || this._getStatusCodeFromErrorCode(code);        return new AppError(code, message, status, details);    }    static _getStatusCodeFromErrorCode(code) {        if (code.includes('INVALID') || code.includes('MISSING')) return 400;        if (code.includes('UNAUTHORIZED') || code.includes('TOKEN')) return 401;        if (code.includes('FORBIDDEN') || code.includes('PERMISSION')) return 403;        if (code.includes('NOT_FOUND')) return 404;        if (code.includes('RATE_LIMIT') || code.includes('TOO_MANY')) return 429;        if (code.includes('FULL') || code.includes('CLOSED') || code.includes('CAPACITY') || code.includes('PAST_DATE')) return 422;        return 500;    }    static handle(error, req = null) {        if (error instanceof AppError) {            return {                error: true,                code: error.code,                message: error.message,                details: error.details,                statusCode: error.statusCode            };        }        if (error.message && error.message.includes('not found')) {            return this.handle(                this.createError(ERROR_CODES.BRANCH_NOT_FOUND, error.message, 404)            );        }        if (error.message && error.message.includes('authentication')) {            return this.handle(                this.createError(ERROR_CODES.UNAUTHORIZED, error.message, 401)            );        }        if (error.code && error.code.startsWith('ER_')) {            return this.handle(                this.createError(ERROR_CODES.DATABASE_ERROR, 'Lỗi cơ sở dữ liệu', 500, {                    dbError: error.code                })            );        }        return {            error: true,            code: ERROR_CODES.INTERNAL_ERROR,            message: ERROR_MESSAGES[ERROR_CODES.INTERNAL_ERROR],            statusCode: 500        };    }    static middleware(err, req, res, next) {        const handled = this.handle(err, req);        const Logger = require('./Logger');        res.status(handled.statusCode).json({            status: 'error',            code: handled.code,            message: handled.message,            ...(handled.details && { details: handled.details })        });    }}module.exports = {    ErrorHandler,    AppError,    ERROR_CODES,    ERROR_MESSAGES};